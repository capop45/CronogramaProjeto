<!doctype html>
<html lang="pt-BR" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gest√£o de Empreendimentos</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Space Grotesk', sans-serif; }
    .gantt-bar { transition: all 0.3s ease; }
    .gantt-bar:hover { filter: brightness(1.2); z-index: 50; }
    .view-btn { transition: all 0.2s ease; }
    .view-btn.active { background: #6366f1 !important; border-color: #6366f1 !important; }
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    .tab-btn { transition: all 0.2s ease; }
    .tab-btn.active { background: #6366f1; color: white; }
    input[type="date"] { color-scheme: dark; }
    
    .stat-card {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(71, 85, 105, 0.5);
      border-radius: 8px;
      padding: 12px;
    }
    
    .milestone-icon {
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        font-size: 16px;
        z-index: 20;
        cursor: pointer;
        filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
        transition: transform 0.2s;
    }
    .milestone-icon:hover { transform: translate(-50%, -50%) scale(1.5); z-index: 60; }

    .gantt-container { position: relative; }
    #loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  </style>
 </head>
 <body class="h-full bg-slate-900 text-slate-100 overflow-auto">
  
  <div id="loading-overlay" class="hidden">
    <div class="text-center">
      <div class="inline-block w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-2"></div>
      <p class="text-sm text-indigo-300 font-semibold">Sincronizando...</p>
    </div>
  </div>

  <div id="app" class="w-full h-full flex flex-col p-6">
   <header class="mb-6 flex justify-between items-start">
    <div>
     <h1 class="text-3xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">Gest√£o de Empreendimentos</h1>
     <p class="text-slate-400 mt-1">Cronograma de Projetos e Obras</p>
    </div>
    <div class="flex gap-2">
      <button id="toggle-dashboard" class="flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors font-medium">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg> Dashboard 
      </button> 
      <button id="download-btn" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors font-medium">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg> Download 
      </button>
    </div>
   </header>
   
   <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 flex-1">
    <div class="lg:col-span-1 bg-slate-800/50 rounded-xl border border-slate-700 p-6 h-fit">
     <div class="flex gap-2 mb-4">
        <button id="tab-tasks" class="tab-btn active flex-1 px-3 py-2 text-sm font-medium rounded bg-indigo-600 text-white"> üè¢ Empreendimentos </button> 
        <button id="tab-milestones" class="tab-btn flex-1 px-3 py-2 text-sm font-medium rounded border border-slate-600 text-slate-300 hover:border-indigo-500"> üìç Marcos </button>
     </div>
     
     <div id="tasks-section">
      <h2 class="text-lg font-bold text-indigo-400 mb-4">‚ûï Novo Empreendimento</h2>
      <form id="task-form" class="space-y-3">
       <div><label class="block text-xs font-medium mb-1 text-slate-300">Nome do Empreendimento</label> <input type="text" id="task-name" placeholder="Ex: Residencial Solar" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-indigo-500 focus:outline-none text-slate-100 text-sm">
       </div>
       <div><label class="block text-xs font-medium mb-1 text-slate-300">Tags</label> <input type="text" id="task-tags" placeholder="Ex: Alto Padr√£o, Centro" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-indigo-500 focus:outline-none text-slate-100 text-sm">
       </div>
       <button type="submit" class="w-full px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors font-medium text-sm"> ‚úì Criar Empreendimento </button>
      </form>
      <div class="mt-4 pt-4 border-t border-slate-700">
       <h3 class="text-xs font-bold text-slate-300 mb-2">Empreendimentos Ativos</h3>
       <div id="task-list" class="space-y-2 max-h-96 overflow-y-auto text-xs">
        <p class="text-slate-500 text-center py-3">Nenhum empreendimento</p>
       </div>
      </div>
     </div>
     
     <div id="milestones-section" class="hidden">
      <h2 class="text-lg font-bold text-purple-400 mb-4">üìç Definir Datas (Marcos)</h2>
      <form id="milestone-form" class="space-y-3">
       <div>
           <label class="block text-xs font-medium mb-1 text-slate-300">Empreendimento</label> 
           <select id="milestone-task" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-indigo-500 focus:outline-none text-slate-100 text-sm"> <option value="">Selecione...</option> </select>
       </div>
       <div>
           <label class="block text-xs font-medium mb-1 text-slate-300">Tipo de Marco</label> 
           <select id="milestone-type" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-indigo-500 focus:outline-none text-slate-100 text-sm">
               <option value="In√≠cio do projeto">üìÇ In√≠cio do projeto</option>
               <option value="Entrega do projeto">üèÅ Entrega do projeto</option>
               <option value="In√≠cio da obra">üèóÔ∏è In√≠cio da obra</option>
           </select>
       </div>
       <div><label class="block text-xs font-medium mb-1 text-slate-300">Data</label> <input type="date" id="milestone-date" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:border-indigo-500 focus:outline-none text-slate-100 text-sm">
       </div>
       <button type="submit" class="w-full px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors font-medium text-sm"> ‚úì Salvar Data </button>
      </form>
      
      <div class="mt-4 pt-4 border-t border-slate-700">
       <h3 class="text-xs font-bold text-slate-300 mb-2">Datas Definidas</h3>
       <div id="milestone-list" class="space-y-2 max-h-96 overflow-y-auto text-xs">
        <p class="text-slate-500 text-center py-3">Nenhuma data adicionada</p>
       </div>
      </div>
     </div>
    </div>

    <div class="lg:col-span-4 grid grid-cols-1 lg:grid-cols-4 gap-4 h-full" id="chart-dashboard-container">
     <div class="lg:col-span-3 bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden flex flex-col">
      <div class="flex gap-2 p-3 border-b border-slate-700 bg-slate-800/30">
          <button id="view-months" class="view-btn active px-3 py-1 text-xs font-medium rounded border border-slate-600 text-slate-300 hover:border-indigo-500"> üìÖ Meses </button> 
          <button id="view-elapsed" class="view-btn px-3 py-1 text-xs font-medium rounded border border-slate-600 text-slate-300 hover:border-indigo-500"> üî¢ Meses Corridos </button>
       <div class="flex-1"></div>
      </div>
      <div id="gantt-chart" class="flex-1 overflow-auto p-3">
       <div class="flex items-center justify-center h-full text-slate-400 text-sm">
        <p>Adicione empreendimentos e marcos para gerar o gr√°fico</p>
       </div>
      </div>
     </div>
     <div id="dashboard-panel" class="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden flex flex-col">
      <div class="p-3 border-b border-slate-700 bg-slate-800/30">
       <h3 class="text-xs font-bold text-purple-400">üìä Estat√≠sticas</h3>
      </div>
      <div id="dashboard" class="flex-1 overflow-y-auto p-3 space-y-2">
       <div class="text-xs text-slate-500 text-center py-6">
        Aguardando dados...
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>

  <script>
    // --- Configura√ß√µes Hardcoded ---
    const API_KEY = '$2a$10$T3C70qhYrKZMczxOir2xUeypvmxIZ89FRuioGyxBSh/gZorc4iBAy';
    const BIN_ID = '699311bf43b1c97be9836b2f';

    const defaultConfig = {
      background_color: '#0f172a',
      surface_color: '#1e293b',
      text_color: '#e2e8f0',
      primary_action: '#6366f1'
    };
    
    // Estado
    let tasks = []; // Agora s√£o "Empreendimentos"
    let milestones = [];
    let viewMode = 'months';
    let dashboardVisible = true;
    let timelineData = null;

    const barColors = [
      '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899',
      '#f43f5e', '#f97316', '#eab308', '#22c55e', '#14b8a6'
    ];

    // --- √çcones e Tipos ---
    const MILESTONE_TYPES = {
        'In√≠cio do projeto': { icon: 'üìÇ', label: 'In√≠cio do projeto', order: 1 },
        'Entrega do projeto': { icon: 'üèÅ', label: 'Entrega do projeto', order: 2 },
        'In√≠cio da obra': { icon: 'üèóÔ∏è', label: 'In√≠cio da obra', order: 3 }
    };

    // --- Integra√ß√£o JSONBin ---
    function showLoading(show) {
        const overlay = document.getElementById('loading-overlay');
        if (show) overlay.classList.remove('hidden');
        else overlay.classList.add('hidden');
    }

    async function loadFromBin() {
        showLoading(true);
        try {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                headers: { 'X-Master-Key': API_KEY, 'X-Bin-Meta': false }
            });
            if (response.ok) {
                const data = await response.json();
                tasks = Array.isArray(data.tasks) ? data.tasks : [];
                milestones = Array.isArray(data.milestones) ? data.milestones : [];
                refreshAll();
            } else {
                console.error('Erro ao carregar:', response.status);
            }
        } catch (error) { console.error('Erro de rede:', error); } 
        finally { showLoading(false); }
    }

    async function saveToBin() {
        showLoading(true);
        try {
            const payload = { tasks, milestones };
            await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                body: JSON.stringify(payload)
            });
            refreshAll();
        } catch (error) { console.error('Erro ao salvar:', error); } 
        finally { showLoading(false); }
    }

    // --- Core Functions ---

    function refreshAll() {
        updateTaskList();
        updateMilestoneList();
        updateTaskSelect();
        renderGantt();
        updateDashboard();
    }

    // --- Event Listeners ---

    document.getElementById('toggle-dashboard').addEventListener('click', () => {
      dashboardVisible = !dashboardVisible;
      const dashboardPanel = document.getElementById('dashboard-panel');
      const chartSection = document.getElementById('gantt-chart').parentElement;
      if (dashboardVisible) {
        dashboardPanel.classList.remove('hidden');
        chartSection.classList.add('lg:col-span-3');
        chartSection.classList.remove('lg:col-span-4');
      } else {
        dashboardPanel.classList.add('hidden');
        chartSection.classList.remove('lg:col-span-3');
        chartSection.classList.add('lg:col-span-4');
      }
    });

    document.getElementById('tab-tasks').addEventListener('click', () => {
      document.getElementById('tasks-section').classList.remove('hidden');
      document.getElementById('milestones-section').classList.add('hidden');
      document.getElementById('tab-tasks').classList.add('active');
      document.getElementById('tab-milestones').classList.remove('active');
    });

    document.getElementById('tab-milestones').addEventListener('click', () => {
      document.getElementById('tasks-section').classList.add('hidden');
      document.getElementById('milestones-section').classList.remove('hidden');
      document.getElementById('tab-tasks').classList.remove('active');
      document.getElementById('tab-milestones').classList.add('active');
    });

    document.getElementById('view-months').addEventListener('click', () => { viewMode = 'months'; updateViewButtons(); renderGantt(); });
    document.getElementById('view-elapsed').addEventListener('click', () => { viewMode = 'elapsed'; updateViewButtons(); renderGantt(); });

    function updateViewButtons() {
      document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
      if (viewMode === 'months') document.getElementById('view-months').classList.add('active');
      if (viewMode === 'elapsed') document.getElementById('view-elapsed').classList.add('active');
    }

    // --- Forms Logic ---

    document.getElementById('task-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('task-name').value.trim();
      const tags = document.getElementById('task-tags').value.trim();
      if (!name) return;

      tasks.push({
        id: Date.now().toString(),
        tarefa: name, // Mantendo chave 'tarefa' por compatibilidade, mas representa Empreendimento
        tags: tags,
        visivel: true
      });
      
      document.getElementById('task-form').reset();
      await saveToBin();
    });

    document.getElementById('milestone-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const taskId = document.getElementById('milestone-task').value;
      const type = document.getElementById('milestone-type').value;
      const date = document.getElementById('milestone-date').value;

      if (!taskId || !date) return;

      // Remove marco anterior do mesmo tipo para este empreendimento (regra de data √∫nica)
      milestones = milestones.filter(m => !(m.tarefa_id === taskId && m.tarefa === type));

      milestones.push({
        id: Date.now().toString(),
        tarefa: type, // Nome do marco √© o tipo
        tarefa_id: taskId,
        data_prevista: date,
        data_realizada: null
      });

      document.getElementById('milestone-form').reset();
      await saveToBin();
    });

    // --- UI Updaters ---

    function updateTaskSelect() {
      const select = document.getElementById('milestone-task');
      const current = select.value;
      select.innerHTML = '<option value="">Selecione...</option>';
      tasks.forEach(t => {
        const option = document.createElement('option');
        option.value = t.id;
        option.textContent = t.tarefa;
        select.appendChild(option);
      });
      select.value = current;
    }

    function updateTaskList() {
      const list = document.getElementById('task-list');
      if (tasks.length === 0) { list.innerHTML = '<p class="text-slate-500 text-center py-3">Vazio</p>'; return; }
      
      list.innerHTML = tasks.map(t => `
        <div class="bg-slate-700/30 p-2 rounded mb-1 flex justify-between items-center">
            <div>
                <span class="font-bold text-sm text-slate-200">${t.tarefa}</span>
                ${t.tags ? `<span class="text-xs text-slate-400 ml-2 border border-slate-600 px-1 rounded">${t.tags}</span>` : ''}
            </div>
            <button onclick="deleteTask('${t.id}')" class="text-xs bg-red-600/50 hover:bg-red-600 text-white px-2 py-1 rounded">Excluir</button>
        </div>
      `).join('');
    }

    function updateMilestoneList() {
      const list = document.getElementById('milestone-list');
      if (milestones.length === 0) { list.innerHTML = '<p class="text-slate-500 text-center py-3">Vazio</p>'; return; }

      // Ordenar por empreendimento e depois por tipo
      const sorted = [...milestones].sort((a,b) => {
          const tA = tasks.find(t => t.id === a.tarefa_id)?.tarefa || '';
          const tB = tasks.find(t => t.id === b.tarefa_id)?.tarefa || '';
          return tA.localeCompare(tB) || (MILESTONE_TYPES[a.tarefa]?.order - MILESTONE_TYPES[b.tarefa]?.order);
      });

      list.innerHTML = sorted.map(m => {
        const t = tasks.find(task => task.id === m.tarefa_id);
        const icon = MILESTONE_TYPES[m.tarefa]?.icon || 'üìç';
        return `
        <div class="bg-slate-700/30 p-2 rounded mb-1 flex justify-between items-center">
            <div>
                <div class="text-xs text-indigo-300 font-bold">${t ? t.tarefa : '???'}</div>
                <div class="text-xs text-slate-300">${icon} ${m.tarefa} : <span class="text-white">${m.data_prevista}</span></div>
            </div>
            <button onclick="deleteMilestone('${m.id}')" class="text-xs text-red-400 hover:text-red-300">‚úï</button>
        </div>
      `}).join('');
    }

    // --- Deletions ---
    window.deleteTask = async (id) => {
        if(!confirm('Excluir este empreendimento e todos os seus marcos?')) return;
        tasks = tasks.filter(t => t.id !== id);
        milestones = milestones.filter(m => m.tarefa_id !== id);
        await saveToBin();
    };
    window.deleteMilestone = async (id) => {
        if(!confirm('Excluir data?')) return;
        milestones = milestones.filter(m => m.id !== id);
        await saveToBin();
    };

    // --- GANTT CORE LOGIC ---

    function getTimelineBounds() {
        if (milestones.length === 0) return null;
        const dates = milestones.map(m => new Date(m.data_prevista + 'T00:00:00').getTime());
        const minRaw = new Date(Math.min(...dates));
        const maxRaw = new Date(Math.max(...dates));
        
        // Come√ßa no dia 1 do m√™s mais antigo
        const minDate = new Date(minRaw.getFullYear(), minRaw.getMonth(), 1);
        // Termina no fim do m√™s mais novo + buffer
        const maxDate = new Date(maxRaw.getFullYear(), maxRaw.getMonth() + 2, 0);
        
        return { minDate, maxDate };
    }

    function getPosFromDate(dateStr, minDate, pxPerMonth) {
        const d = new Date(dateStr + 'T00:00:00'); // For√ßa timezone local/meia noite para evitar desvios
        const totalMonths = (d.getFullYear() - minDate.getFullYear()) * 12 + (d.getMonth() - minDate.getMonth());
        
        // Fra√ß√£o exata do m√™s (dia X de TotalDiasDoMes)
        const daysInMonth = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
        const fraction = (d.getDate() - 1) / daysInMonth; // -1 porque dia 1 √© o in√≠cio (0%)
        
        return (totalMonths + fraction) * pxPerMonth;
    }

    function renderGantt() {
        const container = document.getElementById('gantt-chart');
        const bounds = getTimelineBounds();
        
        if (!bounds || tasks.length === 0) {
            container.innerHTML = '<div class="flex items-center justify-center h-full text-slate-400 text-sm"><p>Sem dados suficientes para o gr√°fico</p></div>';
            return;
        }

        const { minDate, maxDate } = bounds;
        const monthWidth = 60; // Largura fixa da coluna
        const headerHeight = 40;
        const rowHeight = 60;
        const labelWidth = 180;

        // Gerar colunas
        let headers = [];
        let currentDate = new Date(minDate);
        let monthCount = 0;
        
        while (currentDate <= maxDate) {
            let label = viewMode === 'months' 
                ? currentDate.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' })
                : `M√™s ${String(monthCount+1).padStart(2,'0')}`;
            
            headers.push(label);
            currentDate.setMonth(currentDate.getMonth() + 1);
            monthCount++;
        }

        const totalWidth = headers.length * monthWidth;

        let html = `
            <div class="relative gantt-container" style="min-width: ${labelWidth + totalWidth}px;">
                <div class="flex sticky top-0 z-10" style="background: ${defaultConfig.surface_color}; border-bottom: 1px solid #475569;">
                    <div class="flex-shrink-0 p-2 font-bold text-xs flex items-center border-r border-slate-600" style="width: ${labelWidth}px; color: ${defaultConfig.primary_action};">
                        EMPREENDIMENTO
                    </div>
                    <div class="flex">
                        ${headers.map(h => `
                            <div class="flex items-center justify-center text-xs text-slate-400 border-r border-slate-700" style="width: ${monthWidth}px; height: ${headerHeight}px;">
                                ${h}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div>
        `;

        tasks.forEach((task, idx) => {
            const taskMilestones = milestones.filter(m => m.tarefa_id === task.id);
            const startM = taskMilestones.find(m => m.tarefa === 'In√≠cio do projeto');
            const endM = taskMilestones.find(m => m.tarefa === 'Entrega do projeto');
            
            // Cor da linha
            const color = barColors[idx % barColors.length];
            
            html += `
                <div class="flex relative border-b border-slate-700/50 hover:bg-slate-800/50 transition-colors" style="height: ${rowHeight}px;">
                    <div class="flex-shrink-0 p-2 border-r border-slate-700 text-xs font-bold flex flex-col justify-center sticky left-0 bg-slate-900 z-20 shadow-md" style="width: ${labelWidth}px; color: ${color};">
                        <div class="truncate" title="${task.tarefa}">${task.tarefa}</div>
                    </div>
                    
                    <div class="absolute inset-0 left-[${labelWidth}px] flex pointer-events-none">
                        ${headers.map(() => `<div class="border-r border-slate-700/20" style="width: ${monthWidth}px;"></div>`).join('')}
                    </div>

                    <div class="relative flex-1" style="height: 100%;">
            `;

            // Desenhar Barra (Apenas se tiver In√≠cio e Entrega)
            if (startM && endM) {
                const x1 = getPosFromDate(startM.data_prevista, minDate, monthWidth);
                const x2 = getPosFromDate(endM.data_prevista, minDate, monthWidth);
                const width = Math.max(2, x2 - x1);

                html += `
                    <div class="gantt-bar absolute top-[20px] h-[20px] rounded-full shadow-lg" 
                         style="left: ${x1}px; width: ${width}px; background: ${color}40; border: 2px solid ${color};">
                    </div>
                    `;
            }

            // Desenhar √çcones
            taskMilestones.forEach(m => {
                const x = getPosFromDate(m.data_prevista, minDate, monthWidth);
                const typeInfo = MILESTONE_TYPES[m.tarefa];
                if(!typeInfo) return;

                const isStartOrEnd = (m.tarefa === 'In√≠cio do projeto' || m.tarefa === 'Entrega do projeto');
                
                // Se for In√≠cio da Obra, destaca mais
                const isObra = m.tarefa === 'In√≠cio da obra';
                const iconSize = isObra ? 'text-lg' : 'text-base';
                const zIdx = isObra ? 30 : 25;

                html += `
                    <div class="milestone-icon ${iconSize}" style="left: ${x}px; z-index: ${zIdx};" title="${m.tarefa}: ${m.data_prevista}">
                        ${typeInfo.icon}
                        <span class="absolute top-[-15px] left-1/2 -translate-x-1/2 text-[9px] bg-slate-900/90 px-1 rounded opacity-0 hover:opacity-100 whitespace-nowrap pointer-events-none border border-slate-600 transition-opacity">
                            ${m.data_prevista}
                        </span>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;
        });

        html += `</div></div>`;
        container.innerHTML = html;
        
        // Store data for dashboard calc
        timelineData = { minDate, maxDate };
    }

    function updateDashboard() {
        const dash = document.getElementById('dashboard');
        
        if (tasks.length === 0) {
            dash.innerHTML = '<div class="text-xs text-slate-500 text-center py-6">Sem dados</div>';
            return;
        }

        let html = '';

        tasks.forEach((task, idx) => {
            const tMs = milestones.filter(m => m.tarefa_id === task.id);
            const startP = tMs.find(m => m.tarefa === 'In√≠cio do projeto');
            const endP = tMs.find(m => m.tarefa === 'Entrega do projeto');
            const startO = tMs.find(m => m.tarefa === 'In√≠cio da obra');
            const color = barColors[idx % barColors.length];

            let durationBox = '-';
            let gapBox = '-';

            // C√°lculo Dura√ß√£o Projeto (Meses)
            if (startP && endP) {
                const d1 = new Date(startP.data_prevista);
                const d2 = new Date(endP.data_prevista);
                const diffTime = Math.abs(d2 - d1);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                // Converter para meses (arredondando para cima)
                const diffMonths = Math.ceil(diffDays / 30);
                durationBox = `${diffMonths} meses`;
            }

            // C√°lculo Lead Time (Entrega Projeto -> In√≠cio Obra)
            if (endP && startO) {
                const dEnd = new Date(endP.data_prevista);
                const dObra = new Date(startO.data_prevista);
                const diffTime = dObra - dEnd; // Pode ser negativo se obra come√ßar antes
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                const styleColor = diffDays < 0 ? 'text-red-400' : 'text-green-400';
                gapBox = `<span class="${styleColor}">${diffDays} dias</span>`;
            }

            html += `
                <div class="stat-card mb-2 border-l-4" style="border-left-color: ${color};">
                    <div class="flex justify-between mb-1">
                        <span class="font-bold text-xs text-slate-200">${task.tarefa}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-[10px] text-slate-400">
                        <div>
                            <span class="block text-slate-500">Dura√ß√£o Projeto</span>
                            <span class="text-slate-200 font-mono text-xs">${durationBox}</span>
                        </div>
                        <div>
                            <span class="block text-slate-500">Lead Time Obra</span>
                            <span class="text-slate-200 font-mono text-xs">${gapBox}</span>
                        </div>
                    </div>
                </div>
            `;
        });

        dash.innerHTML = html;
    }

    document.getElementById('download-btn').addEventListener('click', async () => {
      const btn = document.getElementById('download-btn');
      btn.disabled = true; btn.style.opacity = '0.5';
      try {
        const canvas = await html2canvas(document.getElementById('gantt-chart'), { backgroundColor: '#0f172a', scale: 2 });
        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = `cronograma-${new Date().toISOString().slice(0,10)}.png`;
        link.click();
      } catch (e) { console.error(e); } 
      finally { btn.disabled = false; btn.style.opacity = '1'; }
    });

    // Start
    loadFromBin();

  </script>
 </body>
</html>